<loading-indicator></loading-indicator>

<div class="pageTitle mb-4">
  <h2>
    <i class="bi bi-list-task"></i>
    ТгіжЎљУеГт«џ - Тќ░тбъ/С┐«Тћ╣ТгіжЎљ
  </h2>
</div>

<collapsible-section
  [id]="'PermissionDetailBody'"
  title="­ЪњЙ УеГт«џТбЮС╗Х"
  tooltipText="УФІУеГт«џТбЮС╗Хсђѓ"
>
  <div *ngIf="showButton" class="d-flex justify-content-end">
    <button
      class="btn d-flex align-items-center gap-2 px-3 py-2 rounded-pill shadow-sm"
      style="background-color: #6f42c1; color: white"
      (click)="addModule()"
    >
      <i class="bi bi-folder-plus"></i>
      <span class="fw-bold">Тќ░тбъТеАухё</span>
    </button>
  </div>

  <div class="permission-form" *ngFor="let group of groupedPermissions">
    <div
      class="module-title d-flex justify-content-between align-items-center mb-2"
    >
      <!-- тиджѓі№╝џТеАухёТгёСйЇ -->
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <!-- ТеАухётљЇуе▒ -->
        <div class="d-flex flex-column" style="width: 180px">
          <label class="form-label mb-1">тљЇуе▒</label>
          <input
            type="text"
            [(ngModel)]="group.header.ModuleName"
            (ngModelChange)="
              clearModuleError(group.header.Uuid, 'ModuleName', $event)
            "
            class="form-control"
            placeholder="ТеАухётљЇуе▒"
            [ngClass]="{
              'is-invalid': fieldErrors[group.header.Uuid].module?.ModuleName
            }"
            [matTooltip]="group.header.ModuleName"
          />
        </div>

        <!-- ТеАухёТЈЈУ┐░ -->
        <div class="d-flex flex-column" style="width: 240px">
          <label class="form-label mb-1">ТЈЈУ┐░</label>
          <input
            type="text"
            [(ngModel)]="group.header.Title"
            (ngModelChange)="
              clearModuleError(group.header.Uuid, 'Title', $event)
            "
            class="form-control"
            placeholder="ТеАухёТЈЈУ┐░"
            [ngClass]="{
              'is-invalid': fieldErrors[group.header.Uuid].module?.Title
            }"
            [matTooltip]="group.header.Title"
          />
        </div>

        <!-- ТеАухётюќуц║ -->
        <div class="d-flex flex-column" style="width: 160px">
          <label class="form-label mb-1">тюќуц║</label>
          <div class="input-group">
            <input
              type="text"
              [(ngModel)]="group.header.Icon"
              (ngModelChange)="
                clearModuleError(group.header.Uuid, 'Icon', $event)
              "
              class="form-control"
              placeholder="УФІУ╝ИтЁЦicon"
              [ngClass]="{
                'is-invalid': fieldErrors[group.header.Uuid].module?.Icon
              }"
              [matTooltip]="group.header.Icon"
            />
            <span class="input-group-text">
              <i
                [class]="group.header.Icon || 'bi bi-circle'"
                [ngClass]="{ 'placeholder-icon': !group.header.Icon }"
              ></i>
            </span>
          </div>
        </div>

        <!-- ТеАухёжђБухљ -->
        <div class="d-flex flex-column" style="width: 140px">
          <label class="form-label mb-1">жђБухљ</label>
          <input
            type="text"
            [(ngModel)]="group.header.Link"
            (ngModelChange)="
              clearModuleError(group.header.Uuid, 'Link', $event)
            "
            class="form-control"
            placeholder="ТеАухёжђБухљ"
            [ngClass]="{
              'is-invalid': fieldErrors[group.header.Uuid].module?.Link
            }"
            [matTooltip]="group.header.Link"
          />
        </div>

        <!-- ТеАухётЋЪуће -->
        <div class="d-flex flex-column" style="width: 40px">
          <label class="form-label mb-1">тЋЪуће</label>
          <mat-checkbox
            [(ngModel)]="group.header.IsUse"
            [matTooltip]="group.header.IsUse ? 'true' : 'false'"
          ></mat-checkbox>
        </div>

        <!-- ТеАухёТјњт║Ј -->
        <div class="d-flex flex-column" style="width: 80px">
          <label class="form-label mb-1">Тјњт║Ј</label>
          <input
            type="number"
            [(ngModel)]="group.header.Sort"
            (ngModelChange)="
              clearModuleError(group.header.Uuid, 'Sort', $event)
            "
            class="form-control text-center sort"
            placeholder="Тјњт║Ј"
            min="0"
            [ngClass]="{
              'is-invalid': fieldErrors[group.header.Uuid].module?.Sort
            }"
            [matTooltip]="'' + group.header.Sort"
          />
        </div>
      </div>

      <!-- тЈ│жѓіТїЅжѕЋ -->
      <div class="d-flex gap-2">
        <button
          *ngIf="group.header.Id === 0"
          class="btn btn-sm d-flex align-items-center gap-1 px-3 py-1 rounded-pill shadow-sm"
          style="background-color: #dc3545; color: white"
          (click)="removeModule(group)"
        >
          <i class="bi bi-trash"></i>
          <span class="fw-bold">тѕфжЎцТеАухё</span>
        </button>

        <button
          class="btn btn-sm d-flex align-items-center gap-1 px-3 py-1 rounded-pill shadow-sm"
          style="background-color: #0d6efd; color: white"
          (click)="addFeature(group)"
        >
          <i class="bi bi-plus-lg"></i>
          <span class="fw-bold">Тќ░тбътіЪУЃй</span>
        </button>
      </div>
    </div>

    <!-- тіЪУЃйУАеТа╝ -->
    <div class="table-wrapper">
      <table class="permission-table">
        <thead>
          <tr>
            <th class="delete-col">тѕфжЎц</th>
            <th class="wide-col">тіЪУЃй</th>
            <th class="wide-col">тіЪУЃйТЈЈУ┐░</th>
            <th class="wide-col">тюќуц║</th>
            <th class="wide-col">жаЂжЮбжђБухљ</th>
            <th class="fixed-col">тЋЪуће</th>
            <th class="fixed-col">тЈ»УдІ</th>
            <th class="fixed-col">Тјњт║Ј</th>
            <th *ngFor="let action of allActions" class="fixed-col">
              {{ action }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of group.items">
            <!-- тѕфжЎц -->
            <td class="delete-col">
              <button
                class="delete-btn"
                (click)="removeFeature(group, item)"
                [disabled]="item.Id !== 0"
              >
                <i class="bi bi-trash"></i>
              </button>
            </td>

            <!-- тіЪУЃйтљЇуе▒ -->
            <td class="wide-col ellipsis">
              <input
                type="text"
                [(ngModel)]="item.FeatureName"
                (ngModelChange)="
                  clearItemError(
                    group.header.Uuid,
                    item.Uuid,
                    'FeatureName',
                    $event
                  )
                "
                class="form-control"
                placeholder="УФІУ╝ИтЁЦтіЪУЃйтљЇуе▒"
                [ngClass]="{
                  'is-invalid':
                    fieldErrors[group.header.Uuid].items[item.Uuid].FeatureName
                }"
                [matTooltip]="item.FeatureName"
              />
            </td>

            <!-- тіЪУЃйТЈЈУ┐░ -->
            <td class="wide-col ellipsis">
              <input
                type="text"
                [(ngModel)]="item.Title"
                (ngModelChange)="
                  clearItemError(group.header.Uuid, item.Uuid, 'Title', $event)
                "
                class="form-control"
                placeholder="УФІУ╝ИтЁЦтіЪУЃйТЈЈУ┐░"
                [ngClass]="{
                  'is-invalid':
                    fieldErrors[group.header.Uuid].items[item.Uuid].Title
                }"
                [matTooltip]="item.Title"
              />
            </td>

            <!-- тіЪУЃйтюќуц║ -->
            <td class="wide-col ellipsis">
              <div class="icon-input-wrapper">
                <input
                  type="text"
                  [(ngModel)]="item.Icon"
                  class="form-control"
                  placeholder="УФІУ╝ИтЁЦicon"
                  [matTooltip]="item.Icon"
                />
                <i
                  [class]="item.Icon || 'bi bi-circle'"
                  [ngClass]="{ 'placeholder-icon': !item.Icon }"
                ></i>
              </div>
            </td>

            <!-- жђБухљ -->
            <td class="wide-col ellipsis">
              <input
                type="text"
                [(ngModel)]="item.Link"
                class="form-control"
                placeholder="УФІУ╝ИтЁЦжђБухљ"
                [matTooltip]="item.Link"
              />
            </td>

            <!-- тЋЪуће -->
            <td class="fixed-col">
              <mat-checkbox
                [(ngModel)]="item.IsUse"
                [matTooltip]="item.IsUse ? 'true' : 'false'"
              ></mat-checkbox>
            </td>

            <!-- тЈ»УдІ -->
            <td class="fixed-col">
              <mat-checkbox
                [(ngModel)]="item.IsVisible"
                [matTooltip]="item.IsVisible ? 'true' : 'false'"
              ></mat-checkbox>
            </td>

            <!-- Тјњт║Ј -->
            <td class="fixed-col">
              <input
                type="number"
                [(ngModel)]="item.Sort"
                (ngModelChange)="
                  clearItemError(group.header.Uuid, item.Uuid, 'Sort', $event)
                "
                class="form-control text-center"
                placeholder="Тјњт║Ј"
                min="0"
                class="form-control sort"
                [ngClass]="{
                  'is-invalid':
                    fieldErrors[group.header.Uuid].items[item.Uuid].Sort
                }"
                [matTooltip]="'' + item.Sort"
              />
            </td>

            <!-- Action ТгёСйЇ -->
            <td
              *ngFor="let action of allActions"
              class="checkbox-cell fixed-col"
            >
              <mat-checkbox
                [(ngModel)]="item.ActionMap[action]"
                (ngModelChange)="onActionChange(group, item, action, $event)"
                [ngClass]="{
                  'is-invalid':
                    fieldErrors[group.header.Uuid].items[item.Uuid].Action
                }"
                [matTooltip]="item.ActionMap[action] ? 'true' : 'false'"
              ></mat-checkbox>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</collapsible-section>

<!-- т║ЋжЃеТЊЇСйюТїЅжѕЋ -->
<div
  *ngIf="showButton"
  class="submit-section text-end d-flex gap-2 justify-content-end mt-3"
>
  <button
    class="btn d-flex align-items-center justify-content-center gap-2 px-4 py-2 rounded-pill shadow-sm"
    style="background-color: #fd7e14; color: white; min-width: 140px"
    (click)="reply()"
    [disabled]="
      areGroupedPermissionsEqual(originalGroupedPermissions, groupedPermissions)
    "
  >
    <i class="bi bi-arrow-counterclockwise fs-5"></i>
    <span class="fw-bold">жѓётјЪ</span>
  </button>

  <button
    class="btn d-flex align-items-center justify-content-center gap-2 px-4 py-2 rounded-pill shadow-sm"
    style="background-color: #198754; color: white; min-width: 140px"
    (click)="onSave()"
    [disabled]="
      areGroupedPermissionsEqual(originalGroupedPermissions, groupedPermissions)
    "
  >
    <i class="bi bi-check-lg fs-5"></i>
    <span class="fw-bold">тё▓тГў</span>
  </button>
</div>
